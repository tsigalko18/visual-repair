<?xml version="1.0" encoding="UTF-8"?>
<project name="ReAssertPlugin" default="export-plugin" basedir=".">

	<fail unless="eclipse.home" message="Run build script in same JRE as Eclipse" />

	<tstamp />
	
	<property name="src.dir" value="src" />
	<property name="bin.dir" value="bin" />
	<property name="lib.dir" value="lib" />
	<property name="dist.dir" value="dist" />
	
	<property name="reassert.project.root" location="../ReAssert" />
	<property name="reassert.build.file" location="${reassert.project.root}/build.xml" />
	<property name="reassert.lib" location="${reassert.project.root}/lib" />
	<property name="reassert.dist" location="${reassert.project.root}/dist" />
	
	<target name="build-reassert">
		<description>
			Builds the base ReAssert project
		</description>
		
		<ant 
			dir="${reassert.project.root}" 
			antfile="${reassert.build.file}" 
			inheritall="false" />
		
		<copy todir="${lib.dir}">
			<fileset
				dir="${reassert.dist}"
				includes="ReAssert*.jar" />
			<!-- strips version number off jar -->
            <mapper type="regexp" from="ReAssert_([0-9\.])+\.jar" to="reassert.jar" />
		</copy>
		
		<copy todir="${lib.dir}">
			<fileset
				dir="${reassert.lib}"
				includes="*.jar" 
				excludes="*-src* *-sources*"/>
		</copy>
		
	</target>
	
	<target name="export-plugin" depends="build-reassert">
		<!-- Adapted from http://www.informit.com/articles/article.aspx?p=1315271&seqNum=4 -->

		<delete dir="${dist.dir}" />
		<mkdir dir="${dist.dir}" />

		<!-- Update version qualifier -->
		<replaceregexp 
			file="META-INF/MANIFEST.MF" 
			match="Bundle\-Version: ([0-9]+\.[0-9]+\.[0-9]+)\.([0-9]+)"
			replace="Bundle-Version: \1.${DSTAMP}${TSTAMP}" />
		
		<!-- Read the MANIFEST.MF -->
		<copy file="META-INF/MANIFEST.MF" tofile="manifest.properties" />
		<replace file="manifest.properties">
			<replacefilter token=":=" value="=" />
			<replacefilter token=":" value="=" />
			<replacefilter token=";" value="" />
		</replace>
		<property file="manifest.properties"/>
		
		<property 
			name="plugin.jar" 
			value="${dist.dir}/${Bundle-Name}_${Bundle-Version}.jar" />

		<jar 
			destfile="${plugin.jar}"
			manifest="META-INF/MANIFEST.MF">
			<fileset dir="${bin.dir}" />
			<fileset dir="." includes="${lib.dir}/**/*" />
			<fileset dir="." includes="META-INF/MANIFEST.MF" />
			<fileset dir="." includes="plugin.xml" />
			<!--<fileset dir="." includes="icons/*.gif" />-->
		</jar>
		
		<!-- Bundle Source -->
		<zip 
            destfile="${dist.dir}/${Bundle-Name}_${Bundle-Version}-src.zip">
			<zipfileset dir="." prefix="${Bundle-Name}_${Bundle-Version}">			
                <exclude name="${bin.dir}/**" />
                <exclude name="${lib.dir}/**" />
                <exclude name="${dist.dir}/**" />
                <exclude name=".*/**" />
			</zipfileset>
            <zipfileset prefix="${Bundle-Name}_${Bundle-Version}" dir="." includes=".classpath"/>
            <zipfileset prefix="${Bundle-Name}_${Bundle-Version}" dir="." includes=".project"/>
        </zip>

	</target>

	<target name="deploy-on-self" depends="export-plugin">
		<fail unless="plugin.jar" message="Plugin was not built" />
		
		<copy file="${plugin.jar}" todir="${eclipse.home}/plugins/" />
		<echo>Restart Eclipse to enable plugin</echo>
	</target>
	
</project>
